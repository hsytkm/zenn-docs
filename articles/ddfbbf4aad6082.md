---
title: "カメラのRAWファイルを使って、被写体の明るさを完全に記録する"
emoji: "📷"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["カメラ", "画像", "RAW", "メモ"]
published: false
---



# はじめに

～下没～

近頃のカメラではフレーミングしてシャッターを押すだけで、誰でも簡単にキレーな写真を撮影することができます。

カメラを趣味にしている方であれば "撮って出し" の写真表現に満足できず、イメージセンサーから出力された "生" 信号である `RAW` ファイル も予め記録しておき、RAW現像ソフト を用いて写真を現像されていることと思います。

~~カメラを趣味にしている方であれば `JPEG` ファイルに加えて、イメージセンサーから出力された "生" 信号である `RAW` ファイル も予め記録しておき、Adobe Lightroom などのソフト を用いて写真現像を行っていることと思います。~~

撮影後に自宅でゆっくり画質を調整できる RAW現像 は大変便利ですが、調整幅できる幅に限界があります。 色味 や ホワイトバランス に関してはかなり自由な調整が可能ですが、AF のピントボケ や AE の高輝度白飛び はRAW現像でフォローすることはできません。

この記事では、RAW現像 で取り返しの効き難い 明るさの調整 を 完全に現像することを目標に、色々と試した内容を紹介していきます。

～上没～



カメラの代表的な制御には、①ピント位置を合わせる **A**uto**F**ocus、②明るさを合わせる **A**uto**E**xposure、③白色を合わせる **A**uto**W**hite**B**lance の 3つ が存在しており、それらをまとめて **3A** と呼ばれています。

**AWB** に関しては、予め イメージセンサーの "生" 信号である RAW ファイル を記録しておけば、RAW現像ソフト（Adobe Lightroomなど）を用いることで、かなり自由に事後調整が効きます。一方 **AF** は ほぼ ※1 事後調整不可、 AE** は 限られた範囲のみ事後調整可 の制限があります。

この記事では、撮影時に明るさの異なる 複数のRAW画像 を予め記録しておくことで、**AE** を事後調整する方法 を紹介していきます。



※1　専用のカメラ（光の方向を記録する）　や　専用のカメラ機能（ピントを動かした画像を撮影しまくる）　を使用すれば対応可能

[新製品レビュー：LYTRO ILLUM - デジカメ Watch Watch](https://dc.watch.impress.co.jp/docs/review/newproduct/680362.html) 

[パナソニック、LUMIX GX8/G7/FZ300に「フォーカスセレクト」機能を追加 - デジカメ Watch Watch](https://dc.watch.impress.co.jp/docs/news/732125.html)



# 前準備

## 撮影機材

今回は RAWファイル を撮影するカメラとして [Canon EOS Kiss X6i](https://global.canon/ja/c-museum/product/dslr811.html) を使用します。 私は一眼カメラ を所有していないので先輩からお借りしました。 撮影に使用するカメラは RAWファイル が記録できて、撮影の明るさを指定できる マニュアル露出モード が搭載されていれば何でも良いと思います。 



## RAWファイルの読み出し

RAWファイルは カメラメーカー によって ファイルフォーマット が異なっており、各社情報を開示していません。 ~~ちなみに Canon は `.CR2` という拡張子で、撮影画像をファイル名でソートしたときに `.JPG` よりも先に列挙される理由で嫌いです~~

通常の写真作品作りの RAW現像 （JPEG作成）であれば、カメラメーカーがリリースしてる現像ソフト や Adobe Lightroom で事足りますが、今回は 明るさ完全記録のために **RAWファイル 内の イメージセンサーの 1ピクセル ごとの出力値を読み出したい** ので、OSS の [dcraw](https://github.com/ncruces/dcraw) を使ってRAWファイルを `.PPM` ファイル に デコードしました。



### デコード設定

EOS Kiss X6i の RAWファイル を  [dcraw-v9.28.2](https://github.com/ncruces/dcraw/releases/tag/v9.28.2-win) のパラメータ引数なし で現像したところ以下の動作になってるようでした。 ~~OSS なのでソースコードを見るのが確実ですが、ソフトが複雑で途中で解析を諦めました。~~

| 設定             | デフォルトの現像結果                         |
| ---------------- | -------------------------------------------- |
| 出力ファイル形式 | ppm  (P6, 8bit)                              |
| ホワイトバランス | 適用されるが、カメラ本体現像と異なってそう。 |
| ガンマ           | 適用されるが、カメラ本体現像と異なってそう。 |

ホワイトバランスは 人間の目にも備わっている機能で、『人間が目で見て白い被写体を白くするために 色チャンネル（RGB）に対してゲインを乗算する制御』のことです。 ホワイトバランス未適用が生のイメージセンサー出力なのですが、未適用だと緑が強い違和感のある画となり（目視で明るさが分かり難くなるので）今回は適用して進めようと思います。

dcraw には カメラ本体のホワイトバランスゲインを使用する `-w` オプションが存在しており、幸い EOS Kiss X6i ではそれっぽく機能しているようです。

ガンマについては詳細を割愛しますが、ざっくり言うと『ディスプレイで表示されたときに、実際に目で見た時と明るさと同じになるように、イメージセンサーの出力値を変換する非線形のカーブ もしくは 変換処理自体』のことです。 



という訳で dcraw の引数には `-6 -W -g 1 1 -w` を設定して、以下の動作としました。

| 設定             | オプション | 本検討の現像                         |
| ---------------- | ---------- | ------------------------------------ |
| 出力ファイル形式 | -6         | ppm (P6, 16bit)                      |
| ホワイトバランス | -w         | 適用する（カメラ本体現像と同じ設定） |
| ガンマ           | -g 1 1 -W  | 適用しない（+ 明るさ補正しない）     |

シャッタスピードを 2倍 長くすると、RAWファイルのピクセル値 が 2倍 になることを確認できました。



### ガンマカーブの調査

RAW ファイル を JPEG ファイル に現像する際に ガンマカーブ が必要となります。 残念ながら dcraw のコマンドに『本体同様の ガンマ処理 を行う』の設定が見当たりませんでした。 dcraw 内蔵のガンマでも問題ないのですが、できれば カメラ本体と同等の設定を使用したいです。仕方ないので、自力で **カメラ本体のガンマカーブを調査** してみます。

調査方法としては 色々な明るさの画像（RAW+JPEG）を撮影し、RAW と JPEG のピクセル値 を2次元にプロットします。（あまりスマートな手段ではありませんが確実です。）

EOS Kiss X6i のガンマカーブ は 以下となりました。









- dcraw をデフォルト設定で現像すると、WhiteBlance も適用されるようです。 WhiteBlance が適用されていないので、白い被写体に色が付いてしまっています。このままでは写真として破綻していますが、WhiteBlance を行うと Red/Green/Blue チャンネルのバランスを整えるために、Red/Blue の値が大きくなってしまいます。今回の検討で邪魔になるので一旦 WhiteBlance なしにします。

  





## RAWファイルの特性調査

今回の記事のためにお借りした [Canon EOS Kiss X6i](https://global.canon/ja/c-museum/product/dslr811.html) について何も知らないので、RAWファイル内の ピクセル出力値 の特性を調査してみました。



- 均一な被写体に対して、絞り と ISO感度 を固定して シャッタスピード のみを 設定可能な最小の単位（1/3段）で変更していきました。 ちなみにシャッタスピードを 1/3段 長くすると、ピクセルの出力値は 1.26倍 に、1段 長くすると 2倍 になります。

- Kiss X6i の イメージセンサーの明るさの表現範囲は、絞りで言うところの X段 の性能がありそうです。 X段なので 1～Y までの明るさを記録できると言い換えられます。
- 







